<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Doctor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
<div th:replace="fragments/header :: header"></div>

<div class="container my-5">
    <h2 class="text-center text-primary mb-4"
        th:text="'Welcome, ' + ${doctor != null ? doctor.fullName : 'Doctor'}">
        Welcome, Doctor
    </h2>

    <!-- Date selector -->
    <form method="get" th:action="@{/doctors/dashboard}" class="mb-4 text-center">
        <label for="date" class="form-label">Select Date:</label>
        <input type="date" id="date" name="date"
               th:value="${selectedDate != null ? selectedDate : T(java.time.LocalDate).now()}"
               class="form-control d-inline-block w-auto mx-2">
        <button type="submit" class="btn btn-primary">View Slots</button>
    </form>

    <!-- Appointment slots table -->
    <div th:if="${slots != null and !slots.isEmpty()}">
        <table class="table table-striped text-center shadow-sm">
            <thead class="table-primary">
            <tr>
                <th>Date</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Patient</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="slot : ${slots}">
                <td th:text="${slot.date}"></td>
                <td th:text="${slot.startTime}"></td>
                <td th:text="${slot.endTime}"></td>
                <td>
                    <span th:if="${slot.patient != null}" th:text="${slot.patient.fullName}"></span>
                    <span th:if="${slot.patient == null}" class="text-muted">â€”</span>
                </td>
                <td>
                    <span th:if="${!slot.booked}" class="text-secondary">Available</span>
                    <span th:if="${slot.booked and !slot.attended}" class="text-warning">Not Attended</span>
                    <span th:if="${slot.attended}" class="text-success">Attended</span>
                </td>
                <td>
                    <div th:if="${slot.booked and !slot.attended}">
                        <button class="btn btn-sm btn-success me-2"
                                th:onclick="'markAttended(' + ${slot.id} + ')'">Mark Attended</button>
                        <button class="btn btn-sm btn-danger"
                                th:onclick="'cancelAppointment(' + ${slot.id} + ')'">Cancel</button>
                    </div>
                    <div th:if="${!slot.booked}">
<!--                        <button class="btn btn-sm btn-outline-secondary" disabled>No Action</button>-->
                        <button class="btn btn-sm" th:classappend="${slot.available ? 'btn-danger' : 'btn-success'}" th:text="${slot.available ? 'Disable' : 'Enable'}" th:onclick="'toggleSlot(' + ${slot.id} + ')'"> </button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${slots == null or slots.isEmpty()}" class="text-center mt-4">
        <h5 class="text-muted">No slots available for this date.</h5>
    </div>
</div>

<script>
    async function toggleSlot(slotId) {
        try {
            const res = await axios.post(`/doctors/toggle-slot/${slotId}`);
            if (res.data === "success") {
                location.reload(); // reload to update slot status
            } else {
                alert("Error toggling slot!");
            }
        } catch (err) {
            console.error(err);
            alert("Server error!");
        }
    }
</script>
<script>
    async function markAttended(slotId) {
        try {
            const res = await axios.post(`/doctors/mark-attended/${slotId}`);
            if (res.data === "success") location.reload();
            else alert("Error marking attended");
        } catch (e) { alert("Server error"); }
    }

    async function cancelAppointment(slotId) {
        try {
            const res = await axios.post(`/doctors/cancel-appointment/${slotId}`);
            if (res.data === "success") location.reload();
            else alert("Error cancelling appointment");
        } catch (e) { alert("Server error"); }
    }
</script>
<script>
     async function toggleSlot(slotId) { try { const res = await axios.post(/doctors/toggle-slot/${slotId}); if (res.data === "success") { location.reload(); // reload to update slot status } else { alert("Error toggling slot!"); } } catch (err) { console.error(err); alert("Server error!"); } }
</script>

<div th:replace="fragments/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
